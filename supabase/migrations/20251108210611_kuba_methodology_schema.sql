-- =====================================================
-- Kuba Methodology Schema Enhancement
-- Breaking changes to support AI-driven split planning,
-- exercise generation, volume optimization, and frequency tracking
-- =====================================================

-- ===================
-- ENUMS
-- ===================

-- Create split_type enum if not exists
DO $$ BEGIN
    CREATE TYPE split_type AS ENUM ('push_pull_legs', 'upper_lower', 'full_body', 'custom');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Create workout_type enum if not exists
DO $$ BEGIN
    CREATE TYPE workout_type AS ENUM ('push', 'pull', 'legs', 'upper', 'lower', 'full_body');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Create workout_variation enum
DO $$ BEGIN
    CREATE TYPE workout_variation AS ENUM ('A', 'B');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- ===================
-- TRAINING APPROACHES ENHANCEMENT
-- ===================

-- Add new JSONB fields for Kuba methodology
ALTER TABLE training_approaches
  ADD COLUMN IF NOT EXISTS volume_landmarks JSONB,
  ADD COLUMN IF NOT EXISTS frequency_guidelines JSONB,
  ADD COLUMN IF NOT EXISTS rom_emphasis JSONB,
  ADD COLUMN IF NOT EXISTS exercise_selection_principles JSONB,
  ADD COLUMN IF NOT EXISTS stimulus_to_fatigue JSONB,
  ADD COLUMN IF NOT EXISTS advanced_techniques JSONB,
  ADD COLUMN IF NOT EXISTS split_variations JSONB,
  ADD COLUMN IF NOT EXISTS periodization JSONB;

COMMENT ON COLUMN training_approaches.volume_landmarks IS 'MEV/MAV/MRV landmarks per muscle group';
COMMENT ON COLUMN training_approaches.frequency_guidelines IS 'Optimal training frequency per muscle group';
COMMENT ON COLUMN training_approaches.rom_emphasis IS 'Percentage distribution of lengthened/shortened/full-range exercises';
COMMENT ON COLUMN training_approaches.exercise_selection_principles IS 'Movement patterns, unilateral requirements, compound/isolation ratios';
COMMENT ON COLUMN training_approaches.stimulus_to_fatigue IS 'Principles and categorization of exercises by S:F ratio';
COMMENT ON COLUMN training_approaches.advanced_techniques IS 'Myoreps, drop sets, rest-pause, lengthened partials protocols';
COMMENT ON COLUMN training_approaches.split_variations IS 'A/B workout variation strategies and examples';
COMMENT ON COLUMN training_approaches.periodization IS 'Mesocycle structure with accumulation, intensification, deload phases';

-- ===================
-- EXERCISE GENERATIONS (BREAKING CHANGE)
-- ===================

-- Drop old exercises table (breaking change - data will be lost)
DROP TABLE IF EXISTS exercises CASCADE;

-- Create new exercise_generations table for AI-generated exercises
CREATE TABLE exercise_generations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  generated_by_ai BOOLEAN DEFAULT true,
  metadata JSONB, -- {primaryMuscles[], secondaryMuscles[], movementPattern, romEmphasis, unilateral, equipmentUsed[]}
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE, -- NULL = global exercise
  usage_count INTEGER DEFAULT 1,
  last_used_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- Create indexes for exercise lookups
CREATE INDEX idx_exercise_name_user ON exercise_generations(name, user_id);
CREATE INDEX idx_exercise_metadata ON exercise_generations USING gin(metadata);
CREATE INDEX idx_exercise_last_used ON exercise_generations(last_used_at DESC);

-- Enable RLS
ALTER TABLE exercise_generations ENABLE ROW LEVEL SECURITY;

-- RLS Policies: users can view global exercises and their own
CREATE POLICY "Users can view global and own exercises"
  ON exercise_generations FOR SELECT
  TO authenticated
  USING (user_id IS NULL OR user_id = auth.uid());

CREATE POLICY "Users can insert own exercises"
  ON exercise_generations FOR INSERT
  TO authenticated
  WITH CHECK (user_id = auth.uid() OR user_id IS NULL);

CREATE POLICY "Users can update own exercises"
  ON exercise_generations FOR UPDATE
  TO authenticated
  USING (user_id = auth.uid());

CREATE POLICY "Users can delete own exercises"
  ON exercise_generations FOR DELETE
  TO authenticated
  USING (user_id = auth.uid());

COMMENT ON TABLE exercise_generations IS 'AI-generated exercises with metadata for intelligent selection';
COMMENT ON COLUMN exercise_generations.name IS 'Exercise name as generated by AI';
COMMENT ON COLUMN exercise_generations.generated_by_ai IS 'Whether this exercise was AI-generated (vs manually added)';
COMMENT ON COLUMN exercise_generations.metadata IS 'JSONB containing primaryMuscles, secondaryMuscles, movementPattern, romEmphasis, unilateral, equipmentUsed';
COMMENT ON COLUMN exercise_generations.user_id IS 'NULL for global exercises, user_id for user-specific generated exercises';
COMMENT ON COLUMN exercise_generations.usage_count IS 'Number of times this exercise has been used in workouts';

-- ===================
-- SPLIT PLANS
-- ===================

CREATE TABLE split_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  approach_id UUID REFERENCES training_approaches(id) ON DELETE SET NULL,
  split_type split_type NOT NULL,
  cycle_days INTEGER NOT NULL CHECK (cycle_days > 0), -- e.g., 8 for Kuba's 3 on 1 off cycle
  sessions JSONB NOT NULL, -- Array of session definitions with day, name, focus, variation, targetVolume, principles
  frequency_map JSONB NOT NULL, -- Map of muscle group -> frequency per week
  volume_distribution JSONB NOT NULL, -- Map of muscle group -> total sets in cycle
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
);

-- Only one active split plan per user
CREATE UNIQUE INDEX idx_one_active_split_per_user ON split_plans(user_id) WHERE active = true;

-- Indexes for queries
CREATE INDEX idx_split_plans_user ON split_plans(user_id);
CREATE INDEX idx_split_plans_active ON split_plans(active);
CREATE INDEX idx_split_plans_split_type ON split_plans(split_type);

-- Enable RLS
ALTER TABLE split_plans ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view their own split plans"
  ON split_plans FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own split plans"
  ON split_plans FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own split plans"
  ON split_plans FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own split plans"
  ON split_plans FOR DELETE
  USING (auth.uid() = user_id);

-- Trigger to auto-update updated_at
CREATE TRIGGER update_split_plans_updated_at
  BEFORE UPDATE ON split_plans
  FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();

COMMENT ON TABLE split_plans IS 'AI-generated training split plans with complete cycle definition';
COMMENT ON COLUMN split_plans.cycle_days IS 'Total days in one complete cycle (e.g., 8 for Kuba method)';
COMMENT ON COLUMN split_plans.sessions IS 'Array of session objects: {day, name, focus[], variation, targetVolume{}, principles[]}';
COMMENT ON COLUMN split_plans.frequency_map IS 'Object mapping muscle groups to training frequency per week';
COMMENT ON COLUMN split_plans.volume_distribution IS 'Object mapping muscle groups to total sets in the cycle';

-- ===================
-- WORKOUTS ENHANCEMENT
-- ===================

-- Add new columns for split integration
ALTER TABLE workouts
  ADD COLUMN IF NOT EXISTS split_plan_id UUID REFERENCES split_plans(id) ON DELETE SET NULL,
  ADD COLUMN IF NOT EXISTS cycle_day INTEGER CHECK (cycle_day > 0),
  ADD COLUMN IF NOT EXISTS workout_type workout_type,
  ADD COLUMN IF NOT EXISTS variation workout_variation;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_workouts_split_plan ON workouts(split_plan_id);
CREATE INDEX IF NOT EXISTS idx_workouts_type ON workouts(workout_type);
CREATE INDEX IF NOT EXISTS idx_workouts_cycle_day ON workouts(cycle_day);

COMMENT ON COLUMN workouts.split_plan_id IS 'Reference to the active split plan this workout belongs to';
COMMENT ON COLUMN workouts.cycle_day IS 'Which day of the split cycle (1 to cycle_days)';
COMMENT ON COLUMN workouts.workout_type IS 'Type of workout (push, pull, legs, upper, lower, full_body)';
COMMENT ON COLUMN workouts.variation IS 'A or B variation of the workout';

-- ===================
-- USER PROFILES ENHANCEMENT
-- ===================

-- Add split planning fields
ALTER TABLE user_profiles
  ADD COLUMN IF NOT EXISTS active_split_plan_id UUID REFERENCES split_plans(id) ON DELETE SET NULL,
  ADD COLUMN IF NOT EXISTS current_cycle_day INTEGER DEFAULT 1 CHECK (current_cycle_day > 0),
  ADD COLUMN IF NOT EXISTS preferred_split split_type;

-- Create index
CREATE INDEX IF NOT EXISTS idx_user_profiles_active_split ON user_profiles(active_split_plan_id);

COMMENT ON COLUMN user_profiles.active_split_plan_id IS 'Currently active split plan for this user';
COMMENT ON COLUMN user_profiles.current_cycle_day IS 'Current position in the split cycle';
COMMENT ON COLUMN user_profiles.preferred_split IS 'User preferred split type (PPL, Upper/Lower, etc.)';

-- ===================
-- HELPER FUNCTIONS
-- ===================

-- Function to deactivate other split plans when one is activated
CREATE OR REPLACE FUNCTION deactivate_other_splits()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.active = true THEN
    UPDATE split_plans
    SET active = false
    WHERE user_id = NEW.user_id
      AND id != NEW.id
      AND active = true;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to enforce single active split
CREATE TRIGGER ensure_single_active_split
  BEFORE INSERT OR UPDATE ON split_plans
  FOR EACH ROW
  WHEN (NEW.active = true)
  EXECUTE FUNCTION deactivate_other_splits();

-- Function to update exercise usage tracking
CREATE OR REPLACE FUNCTION update_exercise_usage()
RETURNS TRIGGER AS $$
DECLARE
  exercise_name TEXT;
BEGIN
  -- Extract exercise names from workout exercises JSONB array
  -- This is a simplified version - adjust based on actual JSONB structure
  FOR exercise_name IN
    SELECT jsonb_array_elements(NEW.exercises)::jsonb->>'name'
  LOOP
    UPDATE exercise_generations
    SET usage_count = usage_count + 1,
        last_used_at = timezone('utc'::text, now())
    WHERE name = exercise_name
      AND (user_id = NEW.user_id OR user_id IS NULL);
  END LOOP;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger to track exercise usage when workout is completed
CREATE TRIGGER track_exercise_usage
  AFTER UPDATE ON workouts
  FOR EACH ROW
  WHEN (OLD.completed = false AND NEW.completed = true)
  EXECUTE FUNCTION update_exercise_usage();

COMMENT ON FUNCTION deactivate_other_splits IS 'Ensures only one split plan is active per user at a time';
COMMENT ON FUNCTION update_exercise_usage IS 'Tracks how often AI-generated exercises are used to maintain consistency';
